/*:
 * @plugindesc Allows custom characters to have multiple expressions to be used in Show Text events.
 * @author SumRndmDde
  *
 * @param == Custom Face 1 ==
 * @default
 *
 * @param Custom Sections 1
 * @desc A list of all the sections that will be customized by Custom Face 1.
 * @default Eyebrows, Mouth
 *
 * @param Custom Pieces 1
 * @desc A list of all the pieces that are used by Custom Face 1. They should be in the same order of Custom Sections 1.
 * @default Eyebrows (10), Mouth (1)
 *
 * @param == Custom Face 2 ==
 * @default
 *
 * @param Custom Sections 2
 * @desc A list of all the sections that will be customized by Custom Face 2.
 * @default Eyes
 *
 * @param Custom Pieces 2
 * @desc A list of all the pieces that are used by Custom Face 2. They should be in the same order of Custom Sections 2.
 * @default Eyes (15)
 *
 * @param == Custom Face 3 ==
 * @default
 *
 * @param Custom Sections 3
 * @desc A list of all the sections that will be customized by Custom Face 3.
 * @default Mouth
 *
 * @param Custom Pieces 3
 * @desc A list of all the pieces that are used by Custom Face 3. They should be in the same order of Custom Sections 3.
 * @default Mouth (5)
 *
 * @param == Custom Face 4 ==
 * @default
 *
 * @param Custom Sections 4
 * @desc A list of all the sections that will be customized by Custom Face 4.
 * @default
 *
 * @param Custom Pieces 4
 * @desc A list of all the pieces that are used by Custom Face 4. They should be in the same order of Custom Sections 4.
 * @default
 *
 * @param == Custom Face 5 ==
 * @default
 *
 * @param Custom Sections 5
 * @desc A list of all the sections that will be customized by Custom Face 5.
 * @default
 *
 * @param Custom Pieces 5
 * @desc A list of all the pieces that are used by Custom Face 5. They should be in the same order of Custom Sections 5.
 * @default
 *
 * @param == Custom Face 6 ==
 * @default
 *
 * @param Custom Sections 6
 * @desc A list of all the sections that will be customized by Custom Face 6.
 * @default
 *
 * @param Custom Pieces 6
 * @desc A list of all the pieces that are used by Custom Face 6. They should be in the same order of Custom Sections 6.
 * @default
 *
 * @param == Custom Face 7 ==
 * @default
 *
 * @param Custom Sections 7
 * @desc A list of all the sections that will be customized by Custom Face 7.
 * @default
 *
 * @param Custom Pieces 7
 * @desc A list of all the pieces that are used by Custom Face 7. They should be in the same order of Custom Sections 7.
 * @default
 *
 * @param == Custom Face 8 ==
 * @default
 *
 * @param Custom Sections 8
 * @desc A list of all the sections that will be customized by Custom Face 8.
 * @default
 *
 * @param Custom Pieces 8
 * @desc A list of all the pieces that are used by Custom Face 8. They should be in the same order of Custom Sections 8.
 * @default
 *
 * @param == Custom Face 9 ==
 * @default
 *
 * @param Custom Sections 9
 * @desc A list of all the sections that will be customized by Custom Face 9.
 * @default
 *
 * @param Custom Pieces 9
 * @desc A list of all the pieces that are used by Custom Face 9. They should be in the same order of Custom Sections 9.
 * @default
 *
 * @param == Custom Face 10 ==
 * @default
 *
 * @param Custom Sections 10
 * @desc A list of all the sections that will be customized by Custom Face 10.
 * @default
 *
 * @param Custom Pieces 10
 * @desc A list of all the pieces that are used by Custom Face 10. They should be in the same order of Custom Sections 10.
 * @default
 *
 * @param == Custom Face 11 ==
 * @default
 *
 * @param Custom Sections 11
 * @desc A list of all the sections that will be customized by Custom Face 11.
 * @default
 *
 * @param Custom Pieces 11
 * @desc A list of all the pieces that are used by Custom Face 11. They should be in the same order of Custom Sections 11.
 * @default
 *
 * @param == Custom Face 12 ==
 * @default
 *
 * @param Custom Sections 12
 * @desc A list of all the sections that will be customized by Custom Face 12.
 * @default
 *
 * @param Custom Pieces 12
 * @desc A list of all the pieces that are used by Custom Face 12. They should be in the same order of Custom Sections 12.
 * @default
 *
 * @param == Custom Face 13 ==
 * @default
 *
 * @param Custom Sections 13
 * @desc A list of all the sections that will be customized by Custom Face 13.
 * @default
 *
 * @param Custom Pieces 13
 * @desc A list of all the pieces that are used by Custom Face 13. They should be in the same order of Custom Sections 13.
 * @default
 *
 * @param == Custom Face 14 ==
 * @default
 *
 * @param Custom Sections 14
 * @desc A list of all the sections that will be customized by Custom Face 14.
 * @default
 *
 * @param Custom Pieces 14
 * @desc A list of all the pieces that are used by Custom Face 14. They should be in the same order of Custom Sections 14.
 * @default
 *
 * @param == Custom Face 15 ==
 * @default
 *
 * @param Custom Sections 15
 * @desc A list of all the sections that will be customized by Custom Face 15.
 * @default
 *
 * @param Custom Pieces 15
 * @desc A list of all the pieces that are used by Custom Face 15. They should be in the same order of Custom Sections 15.
 * @default
 *
 * @param == Custom Face 16 ==
 * @default
 *
 * @param Custom Sections 16
 * @desc A list of all the sections that will be customized by Custom Face 16.
 * @default
 *
 * @param Custom Pieces 16
 * @desc A list of all the pieces that are used by Custom Face 16. They should be in the same order of Custom Sections 16.
 * @default
 *
 * @param == Custom Face 17 ==
 * @default
 *
 * @param Custom Sections 17
 * @desc A list of all the sections that will be customized by Custom Face 17.
 * @default
 *
 * @param Custom Pieces 17
 * @desc A list of all the pieces that are used by Custom Face 17. They should be in the same order of Custom Sections 17.
 * @default
 *
 * @param == Custom Face 18 ==
 * @default
 *
 * @param Custom Sections 18
 * @desc A list of all the sections that will be customized by Custom Face 18.
 * @default
 *
 * @param Custom Pieces 18
 * @desc A list of all the pieces that are used by Custom Face 18. They should be in the same order of Custom Sections 18.
 * @default
 *
 * @param == Custom Face 19 ==
 * @default
 *
 * @param Custom Sections 19
 * @desc A list of all the sections that will be customized by Custom Face 19.
 * @default
 *
 * @param Custom Pieces 19
 * @desc A list of all the pieces that are used by Custom Face 19. They should be in the same order of Custom Sections 19.
 * @default
 *
 * @param == Custom Face 20 ==
 * @default
 *
 * @param Custom Sections 20
 * @desc A list of all the sections that will be customized by Custom Face 20.
 * @default
 *
 * @param Custom Pieces 20
 * @desc A list of all the pieces that are used by Custom Face 20. They should be in the same order of Custom Sections 20.
 * @default
 *
 * @param == Custom Face 21 ==
 * @default
 *
 * @param Custom Sections 21
 * @desc A list of all the sections that will be customized by Custom Face 21.
 * @default
 *
 * @param Custom Pieces 21
 * @desc A list of all the pieces that are used by Custom Face 21. They should be in the same order of Custom Sections 21.
 * @default
 *
 * @param == Custom Face 22 ==
 * @default
 *
 * @param Custom Sections 22
 * @desc A list of all the sections that will be customized by Custom Face 22.
 * @default
 *
 * @param Custom Pieces 22
 * @desc A list of all the pieces that are used by Custom Face 22. They should be in the same order of Custom Sections 22.
 * @default
 *
 * @param == Custom Face 23 ==
 * @default
 *
 * @param Custom Sections 23
 * @desc A list of all the sections that will be customized by Custom Face 23.
 * @default
 *
 * @param Custom Pieces 23
 * @desc A list of all the pieces that are used by Custom Face 23. They should be in the same order of Custom Sections 23.
 * @default
 *
 * @param == Custom Face 24 ==
 * @default
 *
 * @param Custom Sections 24
 * @desc A list of all the sections that will be customized by Custom Face 24.
 * @default
 *
 * @param Custom Pieces 24
 * @desc A list of all the pieces that are used by Custom Face 24. They should be in the same order of Custom Sections 24.
 * @default
 *
 * @param == Custom Face 25 ==
 * @default
 *
 * @param Custom Sections 25
 * @desc A list of all the sections that will be customized by Custom Face 25.
 * @default
 *
 * @param Custom Pieces 25
 * @desc A list of all the pieces that are used by Custom Face 25. They should be in the same order of Custom Sections 25.
 * @default
 *
 * @param == Custom Face 26 ==
 * @default
 *
 * @param Custom Sections 26
 * @desc A list of all the sections that will be customized by Custom Face 26.
 * @default
 *
 * @param Custom Pieces 26
 * @desc A list of all the pieces that are used by Custom Face 26. They should be in the same order of Custom Sections 26.
 * @default
 *
 * @param == Custom Face 27 ==
 * @default
 *
 * @param Custom Sections 27
 * @desc A list of all the sections that will be customized by Custom Face 27.
 * @default
 *
 * @param Custom Pieces 27
 * @desc A list of all the pieces that are used by Custom Face 27. They should be in the same order of Custom Sections 27.
 * @default
 *
 * @param == Custom Face 28 ==
 * @default
 *
 * @param Custom Sections 28
 * @desc A list of all the sections that will be customized by Custom Face 28.
 * @default
 *
 * @param Custom Pieces 28
 * @desc A list of all the pieces that are used by Custom Face 28. They should be in the same order of Custom Sections 28.
 * @default
 *
 * @param == Custom Face 29 ==
 * @default
 *
 * @param Custom Sections 29
 * @desc A list of all the sections that will be customized by Custom Face 29.
 * @default
 *
 * @param Custom Pieces 29
 * @desc A list of all the pieces that are used by Custom Face 29. They should be in the same order of Custom Sections 29.
 * @default
 *
 * @param == Custom Face 30 ==
 * @default
 *
 * @param Custom Sections 30
 * @desc A list of all the sections that will be customized by Custom Face 30.
 * @default
 *
 * @param Custom Pieces 30
 * @desc A list of all the pieces that are used by Custom Face 30. They should be in the same order of Custom Sections 30.
 * @default
 *
 * @param == Custom Face 31 ==
 * @default
 *
 * @param Custom Sections 31
 * @desc A list of all the sections that will be customized by Custom Face 31.
 * @default
 *
 * @param Custom Pieces 31
 * @desc A list of all the pieces that are used by Custom Face 31. They should be in the same order of Custom Sections 31.
 * @default
 *
 * @param == Custom Face 32 ==
 * @default
 *
 * @param Custom Sections 32
 * @desc A list of all the sections that will be customized by Custom Face 32.
 * @default
 *
 * @param Custom Pieces 32
 * @desc A list of all the pieces that are used by Custom Face 32. They should be in the same order of Custom Sections 32.
 * @default
 *
 * @param == Custom Face 33 ==
 * @default
 *
 * @param Custom Sections 33
 * @desc A list of all the sections that will be customized by Custom Face 33.
 * @default
 *
 * @param Custom Pieces 33
 * @desc A list of all the pieces that are used by Custom Face 33. They should be in the same order of Custom Sections 33.
 * @default
 *
 * @param == Custom Face 34 ==
 * @default
 *
 * @param Custom Sections 34
 * @desc A list of all the sections that will be customized by Custom Face 34.
 * @default
 *
 * @param Custom Pieces 34
 * @desc A list of all the pieces that are used by Custom Face 34. They should be in the same order of Custom Sections 34.
 * @default
 *
 * @param == Custom Face 35 ==
 * @default
 *
 * @param Custom Sections 35
 * @desc A list of all the sections that will be customized by Custom Face 35.
 * @default
 *
 * @param Custom Pieces 35
 * @desc A list of all the pieces that are used by Custom Face 35. They should be in the same order of Custom Sections 35.
 * @default
 *
 * @param == Custom Face 36 ==
 * @default
 *
 * @param Custom Sections 36
 * @desc A list of all the sections that will be customized by Custom Face 36.
 * @default
 *
 * @param Custom Pieces 36
 * @desc A list of all the pieces that are used by Custom Face 36. They should be in the same order of Custom Sections 36.
 * @default
 *
 * @param == Custom Face 37 ==
 * @default
 *
 * @param Custom Sections 37
 * @desc A list of all the sections that will be customized by Custom Face 37.
 * @default
 *
 * @param Custom Pieces 37
 * @desc A list of all the pieces that are used by Custom Face 37. They should be in the same order of Custom Sections 37.
 * @default
 *
 * @param == Custom Face 38 ==
 * @default
 *
 * @param Custom Sections 38
 * @desc A list of all the sections that will be customized by Custom Face 38.
 * @default
 *
 * @param Custom Pieces 38
 * @desc A list of all the pieces that are used by Custom Face 38. They should be in the same order of Custom Sections 38.
 * @default
 *
 * @param == Custom Face 39 ==
 * @default
 *
 * @param Custom Sections 39
 * @desc A list of all the sections that will be customized by Custom Face 39.
 * @default
 *
 * @param Custom Pieces 39
 * @desc A list of all the pieces that are used by Custom Face 39. They should be in the same order of Custom Sections 39.
 * @default
 *
 * @param == Custom Face 40 ==
 * @default
 *
 * @param Custom Sections 40
 * @desc A list of all the sections that will be customized by Custom Face 40.
 * @default
 *
 * @param Custom Pieces 40
 * @desc A list of all the pieces that are used by Custom Face 40. They should be in the same order of Custom Sections 40.
 * @default
 *
 * @param == Custom Face 41 ==
 * @default
 *
 * @param Custom Sections 41
 * @desc A list of all the sections that will be customized by Custom Face 41.
 * @default
 *
 * @param Custom Pieces 41
 * @desc A list of all the pieces that are used by Custom Face 41. They should be in the same order of Custom Sections 41.
 * @default
 *
 * @param == Custom Face 42 ==
 * @default
 *
 * @param Custom Sections 42
 * @desc A list of all the sections that will be customized by Custom Face 42.
 * @default
 *
 * @param Custom Pieces 42
 * @desc A list of all the pieces that are used by Custom Face 42. They should be in the same order of Custom Sections 42.
 * @default
 *
 * @param == Custom Face 43 ==
 * @default
 *
 * @param Custom Sections 43
 * @desc A list of all the sections that will be customized by Custom Face 43.
 * @default
 *
 * @param Custom Pieces 43
 * @desc A list of all the pieces that are used by Custom Face 43. They should be in the same order of Custom Sections 43.
 * @default
 *
 * @param == Custom Face 44 ==
 * @default
 *
 * @param Custom Sections 44
 * @desc A list of all the sections that will be customized by Custom Face 44.
 * @default
 *
 * @param Custom Pieces 44
 * @desc A list of all the pieces that are used by Custom Face 44. They should be in the same order of Custom Sections 44.
 * @default
 *
 * @param == Custom Face 45 ==
 * @default
 *
 * @param Custom Sections 45
 * @desc A list of all the sections that will be customized by Custom Face 45.
 * @default
 *
 * @param Custom Pieces 45
 * @desc A list of all the pieces that are used by Custom Face 45. They should be in the same order of Custom Sections 45.
 * @default
 *
 * @param == Custom Face 46 ==
 * @default
 *
 * @param Custom Sections 46
 * @desc A list of all the sections that will be customized by Custom Face 46.
 * @default
 *
 * @param Custom Pieces 46
 * @desc A list of all the pieces that are used by Custom Face 46. They should be in the same order of Custom Sections 46.
 * @default
 *
 * @param == Custom Face 47 ==
 * @default
 *
 * @param Custom Sections 47
 * @desc A list of all the sections that will be customized by Custom Face 47.
 * @default
 *
 * @param Custom Pieces 47
 * @desc A list of all the pieces that are used by Custom Face 47. They should be in the same order of Custom Sections 47.
 * @default
 *
 * @param == Custom Face 48 ==
 * @default
 *
 * @param Custom Sections 48
 * @desc A list of all the sections that will be customized by Custom Face 48.
 * @default
 *
 * @param Custom Pieces 48
 * @desc A list of all the pieces that are used by Custom Face 48. They should be in the same order of Custom Sections 48.
 * @default
 *
 * @param == Custom Face 49 ==
 * @default
 *
 * @param Custom Sections 49
 * @desc A list of all the sections that will be customized by Custom Face 49.
 * @default
 *
 * @param Custom Pieces 49
 * @desc A list of all the pieces that are used by Custom Face 49. They should be in the same order of Custom Sections 49.
 * @default
 *
 * @param == Custom Face 50 ==
 * @default
 *
 * @param Custom Sections 50
 * @desc A list of all the sections that will be customized by Custom Face 50.
 * @default
 *
 * @param Custom Pieces 50
 * @desc A list of all the pieces that are used by Custom Face 50. They should be in the same order of Custom Sections 50.
 * @default
 *
 * @help
 *
 * Custom Faces
 * Version 1.00
 * SumRndmDde
 *
 *
 * This plugin requires the Character Creator plugin:
 * http://sumrndm.site/character-creator/
 *
 *
 * This plugin allows developers to give custom characters multiple expressions
 * through Show Text events. They are created by changing specific pieces of the
 * custom character's face image.
 *
 *
 * ==============================================================================
 *  How to Set up the Parameters
 * ==============================================================================
 *
 * The Parameters are split into sections referred to as "Custom Faces".
 * Each one has a specific amount of sections that are replaced, and the new
 * pieces for each section that is replaced.
 *
 * For example, if you wish Custom Face 1 to force the face image to use the 
 * Mouth (3) file from the Mouth Section, you would do something like this:
 *
 *   Custom Sections 1
 *     Mouth
 *
 *   Custom Pieces 1
 *     Mouth (3)
 *
 *
 * For multiple sections or pieces, simply separate with commas. Make sure the 
 * sections and pieces are in the same order:
 *
 *   Custom Sections 1
 *     Mouth, Eyes, Eyebrows
 *
 *   Custom Pieces 1
 *     Mouth (3), Eyes (5), Eyebrows (4)
 *
 *
 * ==============================================================================
 *  Message Notetags
 * ==============================================================================
 *
 * If you wish to use a custom face, simply add another parameter to the normal
 * Custom Face notetag within the Show Text event:
 *
 *   <CC Face: [actorId], [faceId]>
 *
 * Set [actorId] to the ID of the Actor who's face you wish to be displayed.
 * Set [faceId] to the ID of the custom face created in the Parameters.
 *
 *
 * For example:
 *
 *   <CC Face 1, 3>
 *
 * This would show the custom character face of Actor ID 1 and force the custom
 * face 3 pieces to be used with it.
 *
 *
 * ==============================================================================
 *  End of Help File
 * ==============================================================================
 * 
 * Welcome to the bottom of the Help file.
 *
 *
 * Thanks for reading!
 * If you have questions, or if you enjoyed this Plugin, please check
 * out my YouTube channel!
 *
 * https://www.youtube.com/c/SumRndmDde
 *
 *
 * Until next time,
 *   ~ SumRndmDde
 *
 */

var SRD = SRD || {};
SRD.CustomFaces = SRD.CustomFaces || {};

var Imported = Imported || {};
Imported["SumRndmDde Custom Faces"] = 1.00;

(function(_, __) {

"use strict";

const params = PluginManager.parameters('SRD_CustomFaces');

//-----------------------------------------------------------------------------
// SRD.CustomFaces
//-----------------------------------------------------------------------------

_.sections = [];
_.pieces = [];
for(let i = 1; i <= 50; i++) {
	const section = String(params['Custom Sections ' + i]).split(/\s*,\s*/);
	const piece = String(params['Custom Pieces ' + i]).split(/\s*,\s*/);
	if(section.length > 0 && piece.length > 0) {
		_.sections[i] = section.clone();
		_.pieces[i] = piece.clone();
	}
}

//-----------------------------------------------------------------------------
// DataManager
//-----------------------------------------------------------------------------

let notetagsLoaded = false;
const _DataManager_isDatabaseLoaded = DataManager.isDatabaseLoaded;
DataManager.isDatabaseLoaded = function() {
	if(!_DataManager_isDatabaseLoaded.apply(this, arguments)) return false;
	if(!notetagsLoaded) {
		if(!Imported["SumRndmDde Character Creator"]) {
			alert("Please install 'SRD_CharacterCreator' in order to use 'SRD_CustomFaces'.");
			window.close();
		}
		notetagsLoaded = true;
	}
	return true;
};

//-----------------------------------------------------------------------------
// Game_Actor
//-----------------------------------------------------------------------------

Game_Actor.prototype.getCreatorBitmapFaceThatIsCustom = function(faceId) {
	return $gameCharacterCreations.buildBitmapFaceThatIsCustom(this.actorId(), faceId);
};

//-----------------------------------------------------------------------------
// Game_CharacterCreations
//-----------------------------------------------------------------------------

Game_CharacterCreations.prototype.buildBitmapFaceThatIsCustom = function(id, faceId) {
	const data = this.getInfo(id, 'face');
	const sections = _.sections[faceId];
	const pieces = _.pieces[faceId];
	let fail = false;
	if(!data || !sections || !pieces) return null;
	const bitmap = new Bitmap(__.faceFileWidth, __.faceFileHeight);
	for(let i = 0; i < __.priorities.length; i++) {
		const section = __.priorities[i];
		if(data[section]) {
			const info = data[section];
			const raw = (section.match(/ Part\d+/i)) ? section.replace(/ Part\d+/i, '') : section;
			const index = sections.indexOf(raw);
			let file = info.file;
			if(index >= 0 && !!pieces[index]) {
				file = pieces[index];
			}
			const bit = ImageManager.loadBitmap(info.path, file, info.hue, true);
			const bitTest = ImageManager.loadBitmap(info.path, file, 0, true);
			if(bit.width !== bitTest.width) {
				fail = true;
			}
			bitmap.blt(bit, 0, 0, bit.width, bit.height, 0, 0);
		}
	}
	if(fail) return null;
	return bitmap;
};

Game_CharacterCreations.prototype.reserveBitmapThatIsCustom = function(bitmap, path, file, hue) {
	const bit = ImageManager.loadBitmap(path, file, hue, true);
	bitmap.blt(bit, 0, 0, bit.width, bit.height, 0, 0);
};

//-----------------------------------------------------------------------------
// Window_Base
//-----------------------------------------------------------------------------

Window_Base.prototype.drawCustomFaceThatIsCustom = function(actor, faceId, x, y) {
	const width = Window_Base._faceWidth;
	const height = Window_Base._faceHeight;
	let bitmap;
	if(actor.hasSetImage()) {
		bitmap = actor.getCreatorBitmapFaceThatIsCustom(faceId);
		if(!bitmap) return null;
	} else {
		bitmap = __.loadImage('CustomFace', 0);
	}
	this.contents.clearRect(0, 0, width, height);
	this.contents.blt(bitmap, 0, 0, width, height, x, y);
	return true;
};

//-----------------------------------------------------------------------------
// Window_Message
//-----------------------------------------------------------------------------

const _Window_Message_drawMessageFace = Window_Message.prototype.drawMessageFace;
Window_Message.prototype.drawMessageFace = function() {
	const text = (this._textState) ? this._textState.text : '';
	if(text.match(/<CC\s?Face:\s*(\d+)\s*,\s*(\d+)\s*>/i)) {
		this._textState.text = text.replace(/<CC\s?Face:\s*(\d+)\s*,\s*(\d+)\s*>/i, '');
		const id = parseInt(RegExp.$1);
		const face = parseInt(RegExp.$2);
		const check = this.drawCustomFaceThatIsCustom($gameActors.actor(id), face, 0, 0);
		if(!check) this._redrawSuperCustomFace = [5, id, face];
	} else {
		_Window_Message_drawMessageFace.apply(this, arguments);
	}
};

const _Window_Message_update = Window_Message.prototype.update;
Window_Message.prototype.update = function() {
	_Window_Message_update.apply(this, arguments);
	if(this._redrawSuperCustomFace && this._redrawSuperCustomFace[0] > 0) {
		if(this._redrawSuperCustomFace[0] === 1) {
			const id = this._redrawSuperCustomFace[1];
			const face = this._redrawSuperCustomFace[2];
			this.drawCustomFaceThatIsCustom($gameActors.actor(id), face, 0, 0);
		}
		this._redrawSuperCustomFace[0]--;
		if(this._redrawSuperCustomFace[0] === 0) this._redrawSuperCustomFace = null;
	}
};

})(SRD.CustomFaces, SRD.CharacterCreator);